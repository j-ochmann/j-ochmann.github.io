---
import dayImage from '@/assets/img/globe/day_960x480px.jpg';
import nightImage from '@/assets/img/globe/night_960x480px.jpg';
import cloudsImage from '@/assets/img/globe/clouds_1024x512px.png';
import type { StarlightRouteData } from '@astrojs/starlight/route-data';
import DefaultSidebar from '@astrojs/starlight/components/Sidebar.astro';
import ToolBar from '@/components/ToolBar.astro';
import Icons from '../icons/icons.astro';
import SocialCircle from '@/components/SocialCircle.astro';
import ThemeSelect from '@/components/geo/ThemeSelect.astro';
import { getRelativeLocaleUrl } from 'astro:i18n';
interface Props extends StarlightRouteData {}
const props = Astro.props;
const dayImageUrl = `url(${dayImage.src})`;
const nightImageUrl = `url(${nightImage.src})`;
const cloudsImageUrl = `url(${cloudsImage.src})`;
const lang = Astro.currentLocale || 'en';
const aboutLink = getRelativeLocaleUrl(lang, 'about');
---
<Icons />
<ToolBar />
<!-- Přepínač témat (Slunce/Měsíc) -->
<div class="theme-select-overlay">
  <ThemeSelect />
</div>
<!-- <div class="theme-select-overlay">
  <ThemeSelect />
</div> -->


<div class="social-circle-wrapper" id="geo-social-circle-wrapper">

  <!-- Hlavní globus -->
  <div class="circular-menu">
    <a href={aboutLink} aria-label="About page">
      <div class="profile-img main-img"><div class="clouds"></div></div>
      <div class="profile-img hover-img"><div class="clouds"></div></div>
    </a>
    <SocialCircle />
  </div>
</div>

<div class="wrapper">
  <DefaultSidebar {...Astro.props} />
</div>

<style define:vars={{ dayImageUrl, nightImageUrl, cloudsImageUrl }}>
  .sidebar-geo-header {
    position: relative; /* Klíčové pro správné pozicování dětí */
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-top: 2rem;
  }

  .theme-select-overlay {
    position: absolute;
    /* Umístění v levém horním rohu vzhledem k headeru */
    top: 20px;
    left: 20px;
    z-index: 20; /* Za zeměkoulí */
    pointer-events: none; /* Kontejner propouští kliknutí skrz */
  }

  .theme-select-overlay :global(#theme-toggle) {
    pointer-events: auto; /* Pouze samotné tlačítko reaguje na myš */
  }
  .social-circle-wrapper {
    position: relative;
    z-index: 10; /* Nižší než overlay, ale vyšší než DefaultSidebar */
    /* Pokud tento wrapper překrývá rohy, také mu dáme pointer-events: none */
    pointer-events: none;
  }
  /* 3. Reaktivní části (Zeměkoule a ikony) */
  .circular-menu, 
  .circular-menu a, 
  .social-circle-wrapper :global(.social-icon) {
    /* Tady myš opět zapne pro konkrétní prvky */
    pointer-events: auto;
  }

  .circular-menu a {
    /* Vizuální kruh zůstává, clip-path zde nepoužijeme, 
      aby neřezal nápisy/ikony */
    border-radius: 50%;
  }
  .main-globe-wrapper {
    position: relative;
    z-index: 1; /* Před sluncem/měsícem */
    /* Zajišťuje, že hlavní globus neposune nic nad sebou */
  }
  .main-img {
    background-image: var(--current-main-image);
  }
  .hover-img {
    background-image: var(--current-hover-image);
  }

  /* Logika pro světlý / tmavý režim */
  :global(:root[data-theme='light']) .circular-menu {
    --current-main-image: var(--dayImageUrl);
    --current-hover-image: var(--nightImageUrl);
  }

  :global(:root[data-theme='dark']) .circular-menu {
    --current-main-image: var(--nightImageUrl);
    --current-hover-image: var(--dayImageUrl);
  }
  .profile-img {
    position: absolute;
    width: 180px;
    height: 180px;
    border-radius: 50%;
    overflow: hidden;
    box-shadow: 
      0 10px 30px rgba(0, 0, 0, 0.5),
      0 0 60px rgba(79, 172, 254, 0.5) !important;
    animation: pulse 5s ease-in-out infinite;
  }
  .profile-img::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    border-radius: 50%;
    z-index: 3; /* Musí být nad mapou (::after) */
    
    /* KOMPLEXNÍ STÍNOVÁNÍ */
    background: radial-gradient(
      circle at 30% 30%, 
      rgba(255, 255, 255, 0.15) 0%,   /* Horní odlesk */
      rgba(255, 255, 255, 0) 40%,      /* Průhledný střed */
      rgba(0, 0, 0, 0.4) 70%,          /* Postupné stmívání */
      rgba(0, 0, 0, 0.8) 100%          /* Temná strana planety */
    );
    
    /* Vnitřní hrana pro efekt tloušťky atmosféry */
    box-shadow: inset 2px 2px 5px rgba(255, 255, 255, 0.2);
    pointer-events: none; /* Aby neblokovalo klikání (pokud by bylo potřeba) */
  }
  /* Vytvoříme vrstvu pro samotnou mapu */
  .profile-img::after {
    content: '';
    position: absolute;
    top: -10%; /* Zvětšíme, aby při rotaci nevznikly prázdné rohy */
    left: -10%;
    width: 120%;
    height: 120%;
    
    /* KLÍČOVÝ NÁKLON */
    transform: rotate(23.5deg);
    
    /* Nastavení textury */
    background-image: var(--current-main-image);
    background-size: cover;
    background-repeat: repeat-x;
    
    /* Animace pohybu mapy */
    animation: rotateGlobe 60s linear infinite;
    z-index: 1; /* Pod stínem ::before */
  }

  /* Hover efekt pro změnu obrázku na vnitřní vrstvě */
  .hover-img::after {
    background-image: var(--current-hover-image);
  }

  /* VRSTVA MRAKŮ */
  .clouds {
    position: absolute;
/*    top: -15%; left: -15%;*/
    width: 100%; height: 100%;
    z-index: 2; /* Nad mapou (::after), ale pod stínem (::before) */
    background-image: var(--cloudsImageUrl); /* Musí zde být var() */
    display: block !important; /* Jistota zobrazení */
    background-size: cover;
    background-repeat: repeat-x;
    
    /* JINÝ NÁKLON A RYCHLOST */
    /*transform: rotate(15deg);*/ 
    animation: rotateClouds 45s linear infinite; /* Rychlejší než země (40s) */
    pointer-events: none;
    mix-blend-mode: screen; /* Způsobí, že černá z obrázku mraků zmizí a zbude jen bílá */
  }
  /* Základní opacity pro mraky (Světlý režim) */
  :global(:root[data-theme='light']) .clouds {
    opacity: 0.5;
    transition: opacity 0.5s ease;
  }

  /* Základní opacity pro mraky (Tmavý režim) */
  :global(:root[data-theme='dark']) .clouds {
    opacity: 0.1;
    transition: opacity 0.5s ease;
  }

  /* Hover efekty - detekujeme hover na .profile-img, měníme .clouds uvnitř */
  :global(:root[data-theme='dark']) .profile-img:hover .clouds {
    opacity: 0.5;
  }

  :global(:root[data-theme='light']) .profile-img:hover .clouds {
    opacity: 0.1;
  }


  @keyframes rotateGlobe {
    from { background-position: 0 0; }
    /* Pohyb probíhá po nakloněné ose díky transform: rotate na stejném elementu */
    to { background-position: -400% 0; } 
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }

    @keyframes rotateClouds {
    from { background-position: 0 0; }
    to { background-position: -400% 0; }
  }
  
</style>
