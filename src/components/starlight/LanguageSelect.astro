---
import 'flag-icons/css/flag-icons.min.css';
import { starlightLocales } from '@/content/config/starlight-locales';

const locales = starlightLocales;
const currentLocale = Astro.currentLocale!;

const flagMap: Record<string, string> = {
  en: 'us',
  gb: 'gb',
  cs: 'cz',
  de: 'de',
  fr: 'fr',
  es: 'es',
  sk: 'sk',
  pl: 'pl',
  uk: 'ua',
  ru: 'ru',
  it: 'it',
  nl: 'nl',
  fi: 'fi',
  no: 'no',
  sv: 'se',
  pt: 'pt',
  tr: 'tr',
  el: 'gr',
  zh: 'cn',
  ja: 'jp',
  ko: 'kr',
  hi: 'in',
  ar: 'sa',
  he: 'il',
};

const getFlagCode = (lang: string) => {
  return flagMap[lang] || lang;
};

const getLanguageUrl = (lang: string) => {
  const pathParts = Astro.url.pathname.split('/').filter(Boolean);
  // Add a check for locales to avoid error when it's not passed to the component.
  const langCodes = locales ? Object.keys(locales) : [];

  // Pokud je prvním segmentem cesty kód jazyka, odstraňte ho
  if (pathParts.length > 0 && langCodes.includes(pathParts[0])) {
    pathParts.shift();
  }

  const newPath = pathParts.join('/');

  // Vždy vytváříme URL s jazykovým prefixem
  return `/${lang}/${newPath.startsWith('/') ? newPath.substring(1) : newPath}`;
};
---

{/* Nevykresluj komponentu, pokud je nakonfigurován pouze jeden jazyk */}
{locales && Object.keys(locales).length > 1 && (
  <div class="language-select-wrapper">
    {Object.entries(locales).map(([lang, locale]) => {
      if (!locale) return null;
      const isCurrent = lang === currentLocale;
      const flagCode = getFlagCode(lang);

      return (
        <a
          href={getLanguageUrl(lang)}
          class:list={['lang-link', { active: isCurrent }]}
          aria-label={locale.label}
          title={locale.label}
        >
          <span class={`fi fi-${flagCode}`} aria-hidden="true"></span>
        </a>
      );
    })}
  </div>
)}

<style lang="scss">
  .language-select-wrapper {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    padding: 0 1rem;
  }
  .lang-link {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 21px;
    border-radius: 4px;
    overflow: hidden;
    opacity: 0.6;
    transition: all 0.2s ease-in-out;
    border: 1px solid var(--sl-color-gray-5);
    background-color: var(--sl-color-gray-6);

    span {
      display: block;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
    }

    &.active,
    &:hover {
      opacity: 1;
      transform: scale(1.1);
      border-color: var(--sl-color-accent);
      box-shadow: 0 0 8px -2px var(--sl-color-accent);
    }
  }
</style>