---
import 'flag-icons/css/flag-icons.min.css';
import { locales, getFlagCode } from '@/content/config/i18n';
import config from 'virtual:starlight/user-config';

const currentLocale = Astro.currentLocale?.toString() || 'en';
const currentFlag = getFlagCode(currentLocale);

const getLanguageUrl = (targetLang: string) => {
  const pathParts = Astro.url.pathname.split('/').filter(Boolean);
  const langCodes = Object.keys(locales);
  if (pathParts.length > 0 && langCodes.includes(pathParts[0])) {
    pathParts.shift();
  }
  const slug = pathParts.join('/');
  const isRoot = config.locales?.root && config.locales.root.lang === targetLang;
  return isRoot ? (slug === '' ? '/' : `/${slug}`) : (slug === '' ? `/${targetLang}/` : `/${targetLang}/${slug}`);
};
---

{locales && Object.keys(locales).length > 1 && (
  <div class="language-picker">
    <input type="checkbox" id="lang-toggle-final" class="lang-checkbox" />
    
    <label for="lang-toggle-final" class="language-button">
      <span class:list={['fi', `fi-${currentFlag}`, 'fib', 'current-fi']} aria-hidden="true"></span>
    </label>
    
    {/* Sklo je sourozenec tlačítka i dropdownu, vše je uvnitř pickerru */}
    <label for="lang-toggle-final" class="glass-overlay-fixed"></label>

    <div class="language-dropdown">
      <div class="dropdown-content">
        {Object.entries(locales).map(([code, locale]) => {
          if (!locale) return null;
          const flagCode = getFlagCode(locale.lang);
          return (
            <a href={getLanguageUrl(code)} class:list={['lang-link', { active: code === currentLocale }]}>
              <span class={`fi fi-${flagCode}`} aria-hidden="true"></span>
              <span class="lang-label">{locale.label}</span>
            </a>
          );
        })}
      </div>
    </div>
  </div>
)}

<style lang="scss">
  @use "@/styles/globals.scss" as *;

  // 1. GLOBÁLNÍ ZÁMEK SCROLLU A ROZMAZÁNÍ (CSS 2026)
  :global(html:has(.lang-checkbox:checked)) {
    overflow: hidden !important;
  }

  // Rozmažeme všechno kromě toolbaru (aby byl nad sklem)
  :global(body:has(.lang-checkbox:checked) :where(main, .main-frame, .sidebar-pane, starlight-menu-button)) {
    filter: blur(10px) saturate(140%);
    pointer-events: none;
    transition: filter 0.3s ease;
  }

  // 2. POVÝŠENÍ CELÉHO TOOLBARU (Stacking Context Fix)
  // Aby dropdown mohl být nad sklem, musí se celý toolbar dostat nad z-index skla
  :global(body:has(.lang-checkbox:checked) .toolbar) {
    z-index: 10001 !important; // Vyšší než sklo (10000)
    backdrop-filter: none !important; // Kritické: Vypne filtr rodiče, který blokuje z-index
    background: var(--sl-color-bg-nav) !important;
    overflow: visible !important;
  }

  .language-picker {
    position: relative;
    display: inline-flex;
    z-index: 100;
  }

  .lang-checkbox {
    display: none;
  }

  // 3. SKLO (Overlay)
  .glass-overlay-fixed {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.4);
    z-index: 10000; // Sklo je pod toolbarem (10001)
    
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease;
    cursor: default;
  }

  .lang-checkbox:checked ~ .glass-overlay-fixed {
    opacity: 1;
    visibility: visible;
  }

  // 4. DROPDOWN
  .language-dropdown {
    position: absolute;
    top: calc(100% + 15px);
    right: 0;
    z-index: 10002; // Nejvyšší vrstva v rámci toolbaru
    
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .lang-checkbox:checked ~ .language-dropdown {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .dropdown-content {
    background-color: var(--sl-color-bg-sidebar);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.75rem;
    padding: 0.5rem;
    min-width: 14rem;
    max-height: 70vh;
    overflow-y: auto;
    box-shadow: var(--sl-shadow-xl);
  }

  .language-button {
    cursor: pointer;
    position: relative;
    z-index: 10003; // Nad dropdownem pro zavření
    .current-fi {
      width: 38px; height: 38px;
      border-radius: 50%;
      background-size: cover !important;
    }
  }

  .lang-link {
    display: flex; align-items: center; gap: 0.75rem;
    padding: 0.75rem 1rem; text-decoration: none;
    color: var(--sl-color-gray-2); border-radius: 0.5rem;
    &:hover { background-color: var(--sl-color-gray-6); color: white; }
    &.active { color: var(--sl-color-accent); background-color: var(--sl-color-accent-low); pointer-events: none; }
    .fi { width: 1.25rem; height: 0.9rem; border-radius: 2px; }
  }
</style>
