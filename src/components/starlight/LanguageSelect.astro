---
import 'flag-icons/css/flag-icons.min.css';
import { locales, getFlagCode } from '@/content/config/i18n';
import config from 'virtual:starlight/user-config';

// 1. Získání aktuálního jazyka (s fallbackem na výchozí ze Starlightu)
const currentLocale = Astro.currentLocale || config.defaultLocale || 'en';
// 2. Definice chybějící proměnné currentFlag
const currentFlag = getFlagCode(currentLocale.toString());

const getLanguageUrl = (targetLang: string) => {
  const pathParts = Astro.url.pathname.split('/').filter(Boolean);
  const langCodes = Object.keys(locales);

  // Odstranění stávajícího jazyka z URL
  if (pathParts.length > 0 && langCodes.includes(pathParts[0])) {
    pathParts.shift();
  }

  const slug = pathParts.join('/');
  
  // Detekce, zda je cílový jazyk 'root' (bez prefixu) v astro.config.mjs
  const isRoot = config.locales?.root && config.locales.root.lang === targetLang;

  if (isRoot) {
    return slug === '' ? '/' : `/${slug}`;
  }

  // Pokud prefixujete vše (včetně en), vrátí /targetLang/slug
  return slug === '' ? `/${targetLang}/` : `/${targetLang}/${slug}`;
};
---

{locales && Object.keys(locales).length > 1 && (
  <div class="language-picker" tabindex="0">
    <button type="button" class="picker-button" aria-label="Change language">
      {/* Zde byla chyba - currentFlag musí být definován nahoře */}
      <span class:list={['fi', `fi-${currentFlag}`]} aria-hidden="true"></span>
    </button>
    
<div class="language-dropdown">
  {Object.entries(locales).map(([code, locale]) => {
    if (!locale) return null;
    
    // OPRAVA: Posíláme 'locale.lang' (např. 'en-US'), nikoliv klíč 'code' ('en')
    // Tím zajistíte, že vaše funkce v i18n.ts najde shodu ve sloupci 'lang'
    const flagCode = getFlagCode(locale.lang); 
    
    return (
      <a
        href={getLanguageUrl(code)}
        class:list={['lang-link', { active: code === currentLocale }]}
        title={locale.label}
      >
        <span class={`fi fi-${flagCode}`} aria-hidden="true"></span>
        <span class="lang-label">{locale.label}</span>
      </a>
    );
  })}
</div>

  </div>
)}

<style lang="scss">
  /* ... Vaše SCSS zůstává stejné ... */
  .language-picker {
    position: relative;
    display: inline-flex;
    outline: none;

    &:focus-within .language-dropdown {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
  }
  .picker-button {
    display: flex;
    width: 28px;
    height: 20px;
    border-radius: 4px;
    overflow: hidden;
    border: 1px solid var(--sl-color-gray-5);
    cursor: pointer;
  }
  .language-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    right: 50%;
    transform: translateX(50%) translateY(-10px);
    display: flex;
    flex-direction: column;
    gap: 4px;
    padding: 6px;
    background-color: var(--sl-color-bg-sidebar);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 8px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s ease;
    z-index: 10000;
    min-width: 140px;
  }
  .lang-link {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 6px 10px;
    text-decoration: none;
    color: var(--sl-color-gray-2);
    font-size: var(--sl-text-xs);
    &.active { color: var(--sl-color-accent); pointer-events: none; }
  }
  .fi { display: block; background-size: cover; background-position: center; width: 20px; height: 15px; }
</style>
