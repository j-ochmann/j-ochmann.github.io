---
import 'flag-icons/css/flag-icons.min.css';
import { locales, getFlagCode } from '@/content/config/i18n';
import config from 'virtual:starlight/user-config';

const currentLocale = Astro.currentLocale?.toString() || 'en';
const currentFlag = getFlagCode(currentLocale);
const getLanguageUrl = (targetLang: string) => {
  const pathParts = Astro.url.pathname.split('/').filter(Boolean);
  const langCodes = Object.keys(locales);
  // Odstranění stávajícího jazyka z cesty
  if (pathParts.length > 0 && langCodes.includes(pathParts[0])) {
    pathParts.shift();
  }
  const slug = pathParts.join('/');
  // Detekce, zda je cílový jazyk nastaven jako 'root' (bez prefixu)
  const isRoot = config.locales?.root && config.locales.root.lang === targetLang;

  if (isRoot) {
    return slug === '' ? '/' : `/${slug}`;
  }
  // Vrátí cestu s prefixem (např. /en/ nebo /cs/stranka)
  return slug === '' ? `/${targetLang}/` : `/${targetLang}/${slug}`;
};
---

{locales && Object.keys(locales).length > 1 && (
  <div class="language-picker" tabindex="0">
    <button type="button" class="language-button" aria-label="Change language">
      {/* Aktuální vlajka: použita třída 'fib' pro čtvercový základ a 'current-fi' pro kruh */}
      <span class:list={['fi', `fi-${currentFlag}`, 'fib', 'current-fi']} aria-hidden="true"></span>
    </button>
    
    <div class="language-dropdown">
      {Object.entries(locales).map(([code, locale]) => {
        if (!locale) return null;
        // Používáme locale.lang pro vyhledání v i18n tabulce podle vašeho přání
        const flagCode = getFlagCode(locale.lang);
        
        return (
          <a
            href={getLanguageUrl(code)}
            class:list={['lang-link', { active: code === currentLocale }]}
            title={locale.label}
          >
            <span class={`fi fi-${flagCode}`} aria-hidden="true"></span>
            <span class="lang-label">{locale.label}</span>
          </a>
        );
      })}
    </div>
  </div>
)}

<style lang="scss">
  @use "@/styles/globals.scss" as *;

  .language-picker {
    position: relative;
    display: inline-flex;
    align-items: center;
    z-index: 100; 

    &:focus-within .language-dropdown {
      opacity: 1;
      visibility: visible;
      transform: translateY(-40px);
    }

    .language-button {
      @include icon-base;
      border: none;
      .current-fi {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background-size: cover !important;
        background-position: center;
        flex-shrink: 0;
      }
    }

    .language-button:hover { 
      opacity: 1;
    }
  }

  .language-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    padding: 0.5rem;
    
    background-color: var(--sl-color-bg-sidebar);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.5rem;
    box-shadow: var(--sl-shadow-lg);
    
    // Z-INDEX OPRAVA: Musí být vyšší než zbytek headeru
    z-index: 1000; 
    min-width: 12rem;

    /* Animace */
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .lang-link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.6rem 0.75rem; // Trochu větší plocha pro prsty
    text-decoration: none;
    border-radius: 0.25rem;
    color: var(--sl-color-gray-2);
    font-size: var(--sl-text-sm); // Starlight standard pro texty v menu

    &:hover {
      background-color: var(--sl-color-gray-6);
      color: var(--sl-color-white);
    }

    &.active {
      color: var(--sl-color-accent);
      background-color: var(--sl-color-accent-low);
      pointer-events: none; // Aktivní jazyk není znovu klikatelný
    }

    // Obdélníkové vlajky v menu
    .fi:not(.current-fi) {
      width: 1.25rem;
      height: 0.9rem;
      border-radius: 2px;
      box-shadow: 0 0 1px rgba(0,0,0,0.2);
    }
  }
</style>
