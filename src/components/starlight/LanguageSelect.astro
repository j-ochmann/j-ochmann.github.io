---
import 'flag-icons/css/flag-icons.min.css';
import { locales, getFlagCode } from '@/content/config/i18n';
import config from 'virtual:starlight/user-config';

const currentLocale = Astro.currentLocale?.toString() || 'en';
const currentFlag = getFlagCode(currentLocale);

const getLanguageUrl = (targetLang: string) => {
  const pathParts = Astro.url.pathname.split('/').filter(Boolean);
  const langCodes = Object.keys(locales);
  if (pathParts.length > 0 && langCodes.includes(pathParts[0])) {
    pathParts.shift();
  }
  const slug = pathParts.join('/');
  const isRoot = config.locales?.root && config.locales.root.lang === targetLang;
  return isRoot ? (slug === '' ? '/' : `/${slug}`) : (slug === '' ? `/${targetLang}/` : `/${targetLang}/${slug}`);
};
---

{locales && Object.keys(locales).length > 1 && (
  <div class="language-picker-wrapper">
    <input type="checkbox" id="lang-toggle" class="lang-checkbox" />
    
    <label for="lang-toggle" class="language-button">
      <span class:list={['fi', `fi-${currentFlag}`, 'fib', 'current-fi']} aria-hidden="true"></span>
    </label>
    
    {/* Overlay je nyní fixní k viewportu */}
    <label for="lang-toggle" class="glass-overlay"></label>

    <div class="language-dropdown">
      <div class="dropdown-content">
        {Object.entries(locales).map(([code, locale]) => {
          if (!locale) return null;
          const flagCode = getFlagCode(locale.lang);
          return (
            <a href={getLanguageUrl(code)} class:list={['lang-link', { active: code === currentLocale }]}>
              <span class={`fi fi-${flagCode}`} aria-hidden="true"></span>
              <span class="lang-label">{locale.label}</span>
            </a>
          );
        })}
      </div>
    </div>
  </div>
)}

<style lang="scss">
  @use "@/styles/mixins.scss";
  /* Zámek scrollu při otevření */
  :global(html:has(.lang-checkbox:checked)) {
    overflow: hidden;
  }

  .language-picker-wrapper {
    position: relative;
    display: flex;
    align-items: center;
  }

  .lang-checkbox {
    display: none;
  }

  .language-button {
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 38px;
    height: 38px;
    z-index: 10005; /* Nad overlayem i dropdownem pro zavření */
    
    .current-fi {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background-size: cover !important;
      border: 1px solid var(--sl-color-hairline);
    }
  }

  /* GLASS OVERLAY - Opravená pozice */
  .glass-overlay {
    position: fixed;
    inset: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(4px);
    z-index: 9999; /* Pod tlačítkem a dropdownem */
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  .lang-checkbox:checked ~ .glass-overlay {
    opacity: 1;
    visibility: visible;
  }

  /* DROPDOWN - Opravená vrstva */
  .language-dropdown {
    position: absolute;
    top: calc(100% + 10px);
    right: 0;
    z-index: 10000;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.2s ease;
  }

  .lang-checkbox:checked ~ .language-dropdown {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .dropdown-content {
    background: var(--sl-color-bg-sidebar);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.75rem;
    padding: 0.5rem;
    min-width: 12rem;
    box-shadow: var(--sl-shadow-xl);
  }

  .lang-link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    text-decoration: none;
    color: var(--sl-color-gray-2);
    border-radius: 0.5rem;
    &:hover { background: var(--sl-color-gray-6); color: white; }
    &.active { background: var(--sl-color-accent-low); color: var(--sl-color-accent); }
    .fi { width: 1.25rem; height: 0.9rem; }
  }
</style>
